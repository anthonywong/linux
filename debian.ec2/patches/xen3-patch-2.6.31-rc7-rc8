From: Linux Kernel Mailing List <linux-kernel@vger.kernel.org>
Subject: Linux: 2.6.31-rc8
Patch-mainline: 2.6.31-rc8

 This patch contains the differences between 2.6.31-rc7 and -rc8.

Acked-by: Jeff Mahoney <jeffm@suse.com>
Automatically created from "patches.kernel.org/patch-2.6.31-rc7-rc8" by xen-port-patches.py

--- head-2009-09-02.orig/arch/x86/include/mach-xen/asm/pgtable.h	2009-09-02 11:59:54.000000000 +0200
+++ head-2009-09-02/arch/x86/include/mach-xen/asm/pgtable.h	2009-09-02 12:04:46.000000000 +0200
@@ -2,6 +2,7 @@
 #define _ASM_X86_PGTABLE_H
 
 #include <asm/page.h>
+#include <asm/e820.h>
 
 #include <asm/pgtable_types.h>
 
@@ -272,10 +273,17 @@ static inline pgprot_t pgprot_modify(pgp
 
 #define canon_pgprot(p) __pgprot(massage_pgprot(p))
 
-static inline int is_new_memtype_allowed(unsigned long flags,
-						unsigned long new_flags)
+static inline int is_new_memtype_allowed(u64 paddr, unsigned long size,
+					 unsigned long flags,
+					 unsigned long new_flags)
 {
 	/*
+	 * PAT type is always WB for ISA. So no need to check.
+	 */
+	if (is_ISA_range(paddr, paddr + size - 1))
+		return 1;
+
+	/*
 	 * Certain new memtypes are not allowed with certain
 	 * requested memtype:
 	 * - request is uncached, return cannot be write-back
--- head-2009-09-02.orig/arch/x86/kernel/process-xen.c	2009-09-02 11:59:54.000000000 +0200
+++ head-2009-09-02/arch/x86/kernel/process-xen.c	2009-09-02 12:04:46.000000000 +0200
@@ -503,16 +503,12 @@ static void c1e_idle(void)
 		if (!cpumask_test_cpu(cpu, c1e_mask)) {
 			cpumask_set_cpu(cpu, c1e_mask);
 			/*
-			 * Force broadcast so ACPI can not interfere. Needs
-			 * to run with interrupts enabled as it uses
-			 * smp_function_call.
+			 * Force broadcast so ACPI can not interfere.
 			 */
-			local_irq_enable();
 			clockevents_notify(CLOCK_EVT_NOTIFY_BROADCAST_FORCE,
 					   &cpu);
 			printk(KERN_INFO "Switch to broadcast mode on CPU%d\n",
 			       cpu);
-			local_irq_disable();
 		}
 		clockevents_notify(CLOCK_EVT_NOTIFY_BROADCAST_ENTER, &cpu);
 
--- head-2009-09-02.orig/arch/x86/mm/init_64-xen.c	2009-09-02 11:59:54.000000000 +0200
+++ head-2009-09-02/arch/x86/mm/init_64-xen.c	2009-09-02 12:04:46.000000000 +0200
@@ -1050,7 +1050,7 @@ int __init reserve_bootmem_generic(unsig
 		return ret;
 
 #else
-	reserve_bootmem(phys, len, BOOTMEM_DEFAULT);
+	reserve_bootmem(phys, len, flags);
 #endif
 
 #ifndef CONFIG_XEN
--- head-2009-09-02.orig/arch/x86/mm/pat-xen.c	2009-09-02 11:52:29.000000000 +0200
+++ head-2009-09-02/arch/x86/mm/pat-xen.c	2009-09-02 12:04:46.000000000 +0200
@@ -623,7 +623,8 @@ static int reserve_pfn_range(u64 paddr, 
 		return ret;
 
 	if (flags != want_flags) {
-		if (strict_prot || !is_new_memtype_allowed(want_flags, flags)) {
+		if (strict_prot ||
+		    !is_new_memtype_allowed(paddr, size, want_flags, flags)) {
 			free_memtype(paddr, paddr + size);
 			printk(KERN_ERR "%s:%d map pfn expected mapping type %s"
 				" for %Lx-%Lx, got %s\n",
